name: Integration Test

on:
    workflow_run:
        workflows: ["Docker Build and Push"]
        types: [completed]
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    packages: read

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    integration-test:
        name: Integration Test
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
        steps:
            - name: Validate workflow_run security
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      const workflowRun = context.payload.workflow_run;
                      
                      // Validate workflow_run is from the same repository (not a fork)
                      if (!workflowRun || workflowRun.repository.full_name !== context.repo.owner + '/' + context.repo.repo) {
                        core.setFailed('Security: workflow_run must be from the same repository');
                        return;
                      }
                      
                      // Validate head SHA format
                      const headSha = workflowRun.head_sha;
                      if (!headSha || !/^[a-f0-9]{40}$/i.test(headSha)) {
                        core.setFailed('Invalid head SHA format');
                        return;
                      }
                      
                      // Validate branch is allowed
                      const allowedBranches = ['main'];
                      if (!allowedBranches.includes(workflowRun.head_branch)) {
                        core.setFailed(`Security: workflow_run from branch '${workflowRun.head_branch}' is not allowed. Allowed branches: ${allowedBranches.join(', ')}`);
                        return;
                      }
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  persist-credentials: false
                  ref: ${{ github.event_name == 'workflow_dispatch' && github.sha || github.event.workflow_run.head_sha }}

            - name: Create test config
              env:
                  REPO_OWNER: ${{ github.repository_owner }}
                  REPO_NAME: ${{ github.event.repository.name }}
              run: |
                  cat > test-config.yml << EOF
                  loglevel: info
                  write-directory: evaluation_results
                  write: true
                  output: yaml
                  services:
                    self-test:
                      plugin: github-repo
                      policy:
                        catalogs:
                          - OSPS_B
                        applicability:
                          - Maturity Level 1
                      vars:
                        owner: ${REPO_OWNER}
                        repo: ${REPO_NAME}
                        token: \${{ secrets.GITHUB_TOKEN }}
                  EOF

            - name: Run self-assessment using Docker image
              run: |
                  docker run --rm \
                    -v $(pwd)/test-config.yml:/.privateer/config.yml \
                    -v $(pwd)/evaluation_results:/evaluation_results \
                    ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            - name: Upload evaluation results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: evaluation-results
                  path: evaluation_results/
                  retention-days: 30
