name: Security Scan

on:
    workflow_run:
        workflows: ["build"]
        types: [completed]
        branches: [main, develop]
    workflow_dispatch:

permissions:
    security-events: write
    contents: read
    actions: read
    checks: read

jobs:
    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Check if lint workflow passed
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: runs } = await github.rest.actions.listWorkflowRuns({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          workflow_id: 'lint.yaml',
                          head_sha: '${{ github.event.workflow_run.head_sha }}',
                          per_page: 1
                      });
                      if (runs.workflow_runs.length > 0 && runs.workflow_runs[0].conclusion !== 'success') {
                          core.setFailed('Lint workflow did not pass');
                      }
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  persist-credentials: false

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@0.28.0
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Run Gosec Security Scanner
              uses: securego/gosec@v2.21.4
              with:
                  args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."

            - name: Upload Gosec results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "gosec-results.sarif"
