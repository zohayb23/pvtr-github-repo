name: Security Scan

on:
    workflow_run:
        workflows: ["build"]
        types: [completed]
        branches: [main, develop]
    workflow_dispatch:

permissions:
    security-events: write
    contents: read
    actions: read
    checks: read

jobs:
    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
        steps:
            - name: Validate workflow_run security
              if: github.event_name == 'workflow_run'
              uses: actions/github-script@v7
              with:
                  script: |
                      const workflowRun = context.payload.workflow_run;
                      
                      // Validate workflow_run is from the same repository (not a fork)
                      if (!workflowRun || workflowRun.repository.full_name !== context.repo.owner + '/' + context.repo.repo) {
                        core.setFailed('Security: workflow_run must be from the same repository');
                        return;
                      }
                      
                      // Validate head SHA format
                      const headSha = workflowRun.head_sha;
                      if (!headSha || !/^[a-f0-9]{40}$/i.test(headSha)) {
                        core.setFailed('Invalid head SHA format');
                        return;
                      }
                      
                      // Validate branch is allowed
                      const allowedBranches = ['main', 'develop'];
                      if (!allowedBranches.includes(workflowRun.head_branch)) {
                        core.setFailed(`Security: workflow_run from branch '${workflowRun.head_branch}' is not allowed. Allowed branches: ${allowedBranches.join(', ')}`);
                        return;
                      }
                      
                      // Check if lint workflow passed
                      const { data: runs } = await github.rest.actions.listWorkflowRuns({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          workflow_id: 'lint.yaml',
                          head_sha: headSha,
                          per_page: 1
                      });
                      if (runs.workflow_runs.length > 0 && runs.workflow_runs[0].conclusion !== 'success') {
                          core.setFailed('Lint workflow did not pass');
                      }
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  persist-credentials: false

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@0.28.0
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

            - name: Run Gosec Security Scanner
              uses: securego/gosec@v2.21.4
              with:
                  args: "-no-fail -fmt sarif -out gosec-results.sarif ./..."

            - name: Upload Gosec results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "gosec-results.sarif"
